{% extends 'layout.html' %}
{% load i18n %}

{% block content %}
<div id="webservices">

    <h1>{% trans "Webservices" %}</h1>

    <h2>{% trans "Présentation générale" %}</h2>
    <p>
    L'API du projet ODE autorise les utilisateurs à interagir avec 2 types de données : les événements et les sources. Les sources sont uniquement des URL pointant vers des flux d'événements (au format iCalendar ou json) qui sont lus périodiquement afin de mettre à jour la base de donnée ODE.
    </p>
    <p>
    L'API ODE est basée sur le concept de <a href="http://amundsen.com/media-types/collection/">Collection+JSON</a>, un type de format json orienté vers la lecture/écriture d'hypermédias et pensé pour faciliter la gestion et le requêtage de listes de données. Les événements peuvent aussi être exportés/importés aux formats <a href="https://tools.ietf.org/html/rfc5545">iCalendar</a> et csv. Ce format Collection+JSON n'est toutefois pas utilisé pour les rapports d'erreurs car il n'est pas suffisamment flexible pour nos besoins. Les erreurs sont au format <a href="https://cornice.readthedocs.org/en/latest/validation.html?highlight=error#dealing-with-errors">Cornice</a>.
    </p>

    <h2>{% trans "API RESTful" %}</h2>
    <p>Le format Collection+JSON et l'API ODE sont conformes aux standards REST:</p>
    <ul>
        <li><span class="restful">POST</span> pour ajouter de nouvelles données (exemples),</li>
        <li><span class="restful">PUT</span> pour mettre à jour une donnée existante (exemples),</li>
        <li><span class="restful">GET</span> pour récupérer une <a href="#list-example">liste de données</a> ou une donnée spécifique (exemples),</li>
        <li><span class="restful">DELETE</span> pour supprimer une donnée (exemples),</li>
        <li>l'entête HTTP <span class="restful">Accept</span> pour préciser le format que l'on souhaite récupérer, par exemple <code>Accept: text/calendar</code> pour récupérer des données au format iCalendar,</li>
        <li>l'entête HTTP <span class="restful">Content-Type</span> pour préciser le format fourni, par exemple <code>Content-Type: text/csv</code> pour informer le serveur que des données au format csv lui sont envoyées.</li>
    </ul>

    <h2>{% trans "Authentification" %}</h2>
    <p>
    {% blocktrans %}
    Pour accéder à l'API, veuillez inclure votre clé personnelle dans vos requêtes
    à l'aide de l'entête HTTP <code>Authorization</code>.
    {% endblocktrans %}
    </p>
    <div class="panel panel-default">
      <div class="panel-heading">{% trans 'Votre clé' %}</div>
      <div class="panel-body">
        Token {{ key }}
      </div>
    </div>
    <p>{% trans "Pour tester que vous pouvez bien vous connecter à l'API, exécutez la ligne de commande suivante :" %}</p>
    <pre>curl -I --header "Authorization: Token {{ key }}" {{ events_url }}</pre>
    <p>{% trans "Si la première ligne contient <code>200 OK</code>, tout s'est bien passé ! Si c'est plutôt <code>401 UNAUTHORIZED</code>, cela signifie que vous n'êtes pas autorisé à consulter l'API. Vérifiez vos entêtes HTTP et la valeur du jeton." %}</p>

    <h2>{% trans "URLs accessibles" %}</h2>
    <p>
    {% trans "Les URLs pour accéder aux données sont les suivantes:" %}
    </p>
    <table id="table-api" class="table table-hover">
      <thead>
       <tr>
        <th>{% trans "Méthode" %}</th>
        <th>{% trans "Ressource" %}</th>
        <th>{% trans "Description" %}</th>
       </tr>
      </thead>
      <tbody>
          <tr onclick="document.location='#get-events'">
            <td>GET</td>
            <td>{{ events_url }}</td>
            <td>{% trans "Permet de récupérer tous les événements" %}</td>
          </tr>

          <tr onclick="document.location='#create-events'">
            <td>POST</td>
            <td>{{ events_url }}</td>
            <td>{% trans "Permet de créer un ou plusieurs événements" %}</td>
          </tr>

          <tr onclick="document.location='#get-event'">
            <td>GET</td>
            <td>{{ events_url }}/{id}</td>
            <td>{% trans "Permet de récupérer un événement par son {id}" %}</td>
          </tr>

          <tr onclick="document.location='#update-event'">
            <td>PUT</td>
            <td>{{ events_url }}/{id}</td>
            <td>{% trans "Permet de mettre à jour un événement par son {id}" %}</td>
          </tr>

          <tr onclick="document.location='#delete-event'">
            <td>DELETE</td>
            <td>{{ events_url }}/{id}</td>
            <td>{% trans "Permet de supprimer l'événement {id}" %}</td>
          </tr>                  

          <tr onclick="document.location='#get-sources'">
            <td>GET</td>
            <td>{{ sources_url }}</td>
            <td>{% trans "Permet de récupérer toutes les sources d'événements" %}</td>
          </tr>

          <tr onclick="document.location='#create-source'">
            <td>POST</td>
            <td>{{ sources_url }}</td>
            <td>{% trans "Permet de créer une source d'événements" %}</td>
          </tr>

          <tr onclick="document.location='#get-source'">
            <td>GET</td>
            <td>{{ sources_url }}/{id}</td>
            <td>{% trans "Permet de récupérer une source par son {id}" %}</td>
          </tr>

          <tr onclick="document.location='#update-source'">
            <td>PUT</td>
            <td>{{ sources_url }}/{id}</td>
            <td>{% trans "Permet de mettre à jour une source par son {id}" %}</td>
          </tr>

          <tr onclick="document.location='#delete-source'">
            <td>DELETE</td>
            <td>{{ sources_url }}/{id}</td>
            <td>{% trans "Permet de supprimer la source {id}" %}</td>
          </tr>   
      </tbody>
    </table>

    <div id="get-events" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Récupérer tous les événements" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : GET</code>
            <pre>{{ events_url }}</pre>
        </div>
        <div class="api-entry-description">
            <p>{% trans "Il est possible de récupérer les événements selon plusieurs formats différents. Pour spécifier le format souhaité, il suffit de préciser dans votre requête HTTP le paramètre <strong>Accept</strong> correspondant." %}</p>
            <p>{% trans "Si aucun <strong>Accept</strong> n'est défini, l'API renverra du json." %}</p>
        </div>

        <div class="api-entry-type">
            <h4>JSON</h4>
        
            <div class="api-entry-input">
                <p><span class="input"><strong>{% trans "Entête HTTP" %} :</strong> "Accept: application/vnd.collection+json"</span></p>
            </div>

            <div class="api-entry-output">
                <p><span class="output"><strong>{% trans "Réponse" %} :</strong> json.</span></p>

                <p>Ce json, au format Collection+JSON, ressemblera à:</p>
<pre>
{"collection":
  {"href": "http://localhost:8000/api/v1/events",
   "items": [
      {"href": "http://localhost:8000/api/v1/events/e835ab8248dac8a17b26267c52172786d2eae46d",
       "data": [
          {"name": "id", "value": "e835ab8248dac8a17b26267c52172786d2eae46d"},
          {"name": "description", "value": "Globalisation of Legal Practice And Education\n\nhttp://lanyrd.com/cqxxh"},
          {"name": "title", "value": "CLE Paris Legal Conference"},
          {"name": "url", "value": "http://lanyrd.com/2014/cle-paris-legal-conference/"},
          {"name": "provider_id", "value": "1"},
          {"name": "start_time", "value": "2014-01-09T00:00:00"},
          {"name": "end_time", "value": "2014-01-14T00:00:00"},
          {"name": "location_name", "value": "Hotel Le Meurice, 228 rue de Rivoli, Paris, France, 75001"},
        ]
      }, ...
    ]
  }
}</pre>
                <p>L'attribut <strong>collection</strong> contient une liste d'<strong>items</strong>, correspondant chacun à un événement. Notez la représentation particulière d'un élément, qui contient son lien direct dans l'api sous l'attribut <strong>href</strong>, ainsi que toutes ses données dans l'attribut <strong>data</strong>, stockées sous forme de paire <strong>name</strong>/<strong>value</strong>.</p>
                <p>Cette représentation correspond à celle décrite dans le format <a href="http://amundsen.com/media-types/collection/examples/#ex-item">Collection+JSON</a>.</p>
            </div>
        </div>

        <div class="api-entry-type">
            <h4>CSV</h4>
        
            <div class="api-entry-input">
                <p><span class="input"><strong>{% trans "Entête HTTP" %} :</strong> "Accept: text/csv"</span></p>
            </div>

            <div class="api-entry-output">
                <p><span class="output"><strong>Réponse:</strong> csv.</span></p>

                <p>La donnée retournée sera au format standard csv.</p>
            </div>
        </div>

        <div class="api-entry-type">
            <h4>iCalendar</h4>
        
            <div class="api-entry-input">
                <p><span class="input"><strong>{% trans "Entête HTTP" %} :</strong> "Accept: text/calendar"</span></p>
            </div>

            <div class="api-entry-output">
                <p><span class="output"><strong>Réponse:</strong> iCal.</span></p>

                <p>La donnée retournée sera au format standard iCal.</p>
            </div>
        </div>
    </div>

    <div id="create-events" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Créer un événement" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : POST</code>
            <pre>{{ events_url }}</pre>
        </div>
    </div>

    <div id="get-event" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Récupérer un événement" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : GET</code>
            <pre>{{ events_url }}/{id}</pre>
        </div>
    </div>

    <div id="update-event" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Mettre à jour un événement" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : PUT</code>
            <pre>{{ events_url }}/{id}</pre>
        </div>
    </div>

    <div id="delete-event" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Supprimer un événement" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : DELETE</code>
            <pre>{{ events_url }}/{id}</pre>
        </div>
    </div>   

    <div id="get-sources" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Récupérer les sources d'événements" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : GET</code>
            <pre>{{ sources_url }}</pre>
        </div>
    </div>    

    <div id="create-source" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Créer une source d'événement" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : POST</code>
            <pre>{{ sources_url }}</pre>
        </div>
    </div>

    <div id="get-source" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Récupérer une source d'événements" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : GET</code>
            <pre>{{ sources_url }}/{id}</pre>
        </div>
    </div>      

    <div id="update-source" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Mettre à jour une source d'événements" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : PUT</code>
            <pre>{{ sources_url }}/{id}</pre>
        </div>
    </div>

    <div id="delete-source" class="api-entry">
        <div class="api-entry-title">
            <h3>{% trans "Supprimer une source d'événements" %}</h3>
        </div>
        <div class="api-entry-resource">
            <code>{% trans "Méthode" %} : DELETE</code>
            <pre>{{ sources_url }}/{id}</pre>
        </div>
    </div>       

    <h2>{% trans "Paramètres GET pour les Collections" %}</h2>
    <p>{% trans "Les requêtes sur les collections acceptent les paramètres GET suivants :" %}</p>
    <ul>
        <li>{% trans "limit: nombre maximum d'objets retournés," %}</li>
        <li>{% trans "offset: numéro du premier objet souhaité," %}</li>
        <li>{% trans "sort_by: champ par lequel la collection va être triée," %}</li>
        <li>{% trans "sort_direction: sens du tri (asc: ordre croissant, desc: ordre décroissant), par défaut croissant," %}</li>
        <li>{% trans "provider_id: ne renvoie que les données liées au fournisseur dont l'id est fournie" %}</li>
    </ul>

    <p>Par exemple, si vous voulez récupérer les événements 20 à 30 triés par date de début en ordre décroissant, voici l'URL correspondante :</p>
    <pre>{{ events_url }}?offset=20&limit=10&sort_by=start_time&sort_direction=desc</pre>

    <h2>{% trans "Plus d'informations" %}</h2>
    Voir <a href="https://ode.readthedocs.org/">la documentation</a> pour plus d'informations.



</div>

{% endblock %}
